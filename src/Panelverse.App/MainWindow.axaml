<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:Panelverse.App.ViewModels"
        xmlns:conv="clr-namespace:Panelverse.App.Converters"
        mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
        x:Class="Panelverse.App.MainWindow"
        Title="Panelverse"
        x:DataType="vm:ShellViewModel">

	<Window.Resources>
		<conv:FilePathToBitmapConverter x:Key="FilePathToBitmapConverter" />
	</Window.Resources>

	<Window.DataTemplates>
		<!-- Library view template -->
		<DataTemplate x:DataType="vm:LibraryViewModel" DataType="{x:Type vm:LibraryViewModel}">
			<Grid RowDefinitions="Auto,*" ColumnDefinitions="*">
				<!-- Header bar -->
				<Border Background="{DynamicResource ThemeBackgroundBrush}" Padding="16">
					<Grid ColumnDefinitions="Auto,*,Auto,Auto,Auto" VerticalAlignment="Center" ColumnSpacing="12">
						<TextBlock Text="Panelverse" FontSize="20" FontWeight="Bold" VerticalAlignment="Center" />
						<TextBox Grid.Column="1" Watermark="Search…" Text="{Binding SearchText, Mode=TwoWay}" />
						<ComboBox Grid.Column="2" MinWidth="160" ItemsSource="{Binding FilterOptions}"
								SelectedItem="{Binding SelectedFilter}" />
						<ComboBox Grid.Column="3" MinWidth="160" ItemsSource="{Binding SortOptions}"
								SelectedItem="{Binding SelectedSort}" />
						<StackPanel Grid.Column="4" Orientation="Horizontal" Spacing="8">
							<Button Content="Add File" Command="{Binding AddFileCommand}" />
							<Button Content="Add Folder" Command="{Binding AddFolderCommand}" />
							<Button Content="Refresh" Command="{Binding RefreshCommand}" IsVisible="{Binding IsDebug}" />
							<Button Content="Reset DB" Command="{Binding ResetDatabaseCommand}" IsVisible="{Binding IsDebug}" />
							<Button Content="☰" />
						</StackPanel>
					</Grid>
				</Border>

				<!-- Content: library grid -->
				<ScrollViewer Grid.Row="1">
					<ItemsControl ItemsSource="{Binding Items}">
						<ItemsControl.ItemsPanel>
							<ItemsPanelTemplate>
								<WrapPanel Orientation="Horizontal" />
							</ItemsPanelTemplate>
						</ItemsControl.ItemsPanel>
						<ItemsControl.ItemTemplate>
							<DataTemplate x:DataType="vm:LibraryItemViewModel">
								<Border x:Name="Card" Width="180" Height="260" Margin="8" CornerRadius="8" 
										Background="{DynamicResource ThemeControlLowBrush}" 
										BorderBrush="{DynamicResource ThemeBorderLowBrush}" BorderThickness="1">
									<Grid>

										<!-- Thumbnail image -->
										<Image Source="{Binding ThumbnailPath, Converter={StaticResource FilePathToBitmapConverter}}"
											   Stretch="UniformToFill"/>

										<!-- Status dot (top-left) -->
										<Ellipse Width="10" Height="10" Margin="8" HorizontalAlignment="Left" VerticalAlignment="Top"
												Fill="{Binding StatusBrush}" StrokeThickness="0" />

										<!-- Pages label (bottom-right) -->
										<Border Background="#66000000" CornerRadius="4" Padding="4,2" HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="8">
											<TextBlock Text="{Binding PagesLabel}" FontSize="11"/>
										</Border>

										<!-- Hover overlay at bottom -->
										<Grid x:Name="HoverOverlay" IsVisible="{Binding #Card.IsPointerOver}" VerticalAlignment="Bottom">
											<Border CornerRadius="0,0,8,8" Padding="8">
												<Border.Background>
													<LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
														<GradientStop Offset="0" Color="Transparent"/>
														<GradientStop Offset="0.3" Color="#DDFFFFFF"/>
														<GradientStop Offset="1" Color="White"/>
												</LinearGradientBrush>
											</Border.Background>
											<StackPanel Spacing="2">
												<TextBlock Text="{Binding Title}" FontWeight="SemiBold" TextTrimming="CharacterEllipsis" Foreground="#333333"/>
												<TextBlock Text="{Binding SeriesAndVolume}" Foreground="#666666" FontSize="12"/>
												<TextBlock Text="{Binding PagesLabel, StringFormat='Read {0}'}" Foreground="#444444" FontSize="11" Margin="0,2,0,4"/>
												<StackPanel Orientation="Horizontal" Spacing="8">
													<Button Content="Resume" IsVisible="{Binding !IsUnread}"
															Command="{Binding $parent[Window].DataContext.OpenItemCommand}"
															CommandParameter="{Binding}" />
													<Button Content="Open" IsVisible="{Binding IsUnread}"
															Command="{Binding $parent[Window].DataContext.OpenItemCommand}"
															CommandParameter="{Binding}" />
													<Button Content="Details" />
												</StackPanel>
											</StackPanel>
										</Border>
									</Grid>

									<!-- Linear progress (in-progress) -->
									<ProgressBar Minimum="0" Maximum="100" Value="{Binding ProgressPercent}"
											Height="4" VerticalAlignment="Bottom" IsVisible="{Binding IsInProgress}"/>

								</Grid>

								<Border.ContextMenu>
									<ContextMenu>
										<MenuItem Header="Resume" IsVisible="{Binding IsInProgress}"
												Command="{Binding $parent[Window].DataContext.OpenItemCommand}"
												CommandParameter="{Binding}" />
										<MenuItem Header="Open" IsVisible="{Binding IsUnread}"
												Command="{Binding $parent[Window].DataContext.OpenItemCommand}"
												CommandParameter="{Binding}" />
										<MenuItem Header="Open" IsVisible="{Binding IsCompleted}"
												Command="{Binding $parent[Window].DataContext.OpenItemCommand}"
												CommandParameter="{Binding}" />
										<MenuItem Header="Continue from…" />
										<Separator/>
										<MenuItem Header="Mark as Completed" IsVisible="{Binding IsInProgress}" />
										<MenuItem Header="Mark as Unread" IsVisible="{Binding IsCompleted}" />
										<Separator/>
										<MenuItem Header="Edit Metadata…" />
										<MenuItem Header="Reveal in Explorer/Finder" />
										<MenuItem Header="Rescan Thumbnails" />
										<Separator/>
										<MenuItem Header="Remove from Library" />
									</ContextMenu>
								</Border.ContextMenu>
							</Border>
						</DataTemplate>
						</ItemsControl.ItemTemplate>
					</ItemsControl>
				</ScrollViewer>
			</Grid>
		</DataTemplate>

		<!-- Reader view template -->
		<DataTemplate x:DataType="vm:ReaderViewModel" DataType="{x:Type vm:ReaderViewModel}">
			<Grid RowDefinitions="Auto,*">
				<Border Background="{DynamicResource ThemeBackgroundBrush}" Padding="16">
					<StackPanel Orientation="Horizontal" Spacing="12">
						<Button Content="← Back" Command="{Binding $parent[Window].DataContext.NavigateBackToLibraryCommand}" />
						<TextBlock Text="{Binding Title}" FontSize="18" FontWeight="SemiBold" VerticalAlignment="Center"/>
					</StackPanel>
				</Border>
				<ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto" x:Name="ReaderScroll">
					<Border Focusable="True">
						<Border.KeyBindings>
							<KeyBinding Command="{Binding PrevPageCommand}" Gesture="Left" />
							<KeyBinding Command="{Binding NextPageCommand}" Gesture="Right" />
						</Border.KeyBindings>
						<Image Source="{Binding CurrentImage}" Stretch="Uniform"/> 
					</Border>
				</ScrollViewer>
			</Grid>
		</DataTemplate>
	</Window.DataTemplates>

	<!-- Host current view model -->
	<ContentControl Content="{Binding CurrentViewModel}" />

</Window>
